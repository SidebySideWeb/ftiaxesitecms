{"version":3,"sources":["../../../../../src/lib/tenant-server.ts","../../../../../src/actions/globals.ts"],"sourcesContent":["import { headers } from \"next/headers\";\r\nimport { cookies } from \"next/headers\";\r\nimport { createServerClient } from \"@supabase/ssr\";\r\nimport { supabaseServer } from \"./supabase\";\r\n\r\n/**\r\n * Gets the tenant ID for the current request.\r\n * Tries multiple strategies:\r\n * 1. From host subdomain (production)\r\n * 2. From user's session via tenant_users table (development/localhost)\r\n * 3. Default tenant \"kalitechnia\" as fallback\r\n */\r\nexport async function getTenantIdForServerAction(): Promise<string | null> {\r\n  try {\r\n    // Strategy 1: Try to get from host subdomain\r\n    const headersList = await headers();\r\n    const host = headersList.get(\"host\") || headersList.get(\"x-forwarded-host\");\r\n\r\n    if (host) {\r\n      const hostname = host.split(\":\")[0];\r\n      const parts = hostname.split(\".\");\r\n\r\n      // If we have a subdomain (more than 2 parts), use it\r\n      if (parts.length > 2) {\r\n        const tenantSlug = parts[0];\r\n        const supabase = supabaseServer();\r\n        const { data: tenant, error } = await supabase\r\n          .from(\"tenants\")\r\n          .select(\"id\")\r\n          .eq(\"slug\", tenantSlug)\r\n          .maybeSingle();\r\n\r\n        if (tenant && !error) {\r\n          return tenant.id;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Strategy 2: Get from user's session (for localhost/development)\r\n    const cookieStore = await cookies();\r\n    const supabase = createServerClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n      {\r\n        cookies: {\r\n          get(name: string) {\r\n            return cookieStore.get(name)?.value;\r\n          },\r\n        },\r\n      }\r\n    );\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (user) {\r\n      // Get user's first tenant from tenant_users\r\n      const { data: tenantUser, error: tenantUserError } = await supabase\r\n        .from(\"tenant_users\")\r\n        .select(\"tenant_id\")\r\n        .eq(\"user_id\", user.id)\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (tenantUser?.tenant_id && !tenantUserError) {\r\n        return tenantUser.tenant_id;\r\n      }\r\n    }\r\n\r\n    // Strategy 3: Fallback to default tenant \"kalitechnia\"\r\n    const supabaseAdmin = supabaseServer();\r\n    const { data: defaultTenant, error: defaultTenantError } = await supabaseAdmin\r\n      .from(\"tenants\")\r\n      .select(\"id\")\r\n      .eq(\"slug\", \"kalitechnia\")\r\n      .maybeSingle();\r\n\r\n    if (defaultTenant && !defaultTenantError) {\r\n      return defaultTenant.id;\r\n    }\r\n\r\n    return null;\r\n  } catch (error) {\r\n    console.error(\"Error getting tenant ID:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n","\"use server\";\r\n\r\nimport { supabaseServer } from \"@/lib/supabase\";\r\nimport { getTenantIdForServerAction } from \"@/lib/tenant-server\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\n/**\r\n * Get all globals for the current tenant\r\n */\r\nexport async function getGlobals() {\r\n  try {\r\n    const tenantId = await getTenantIdForServerAction();\r\n    if (!tenantId) {\r\n      return { error: \"Tenant not found\" };\r\n    }\r\n\r\n    const supabase = supabaseServer();\r\n\r\n    // Get all globals for tenant\r\n    const { data: globals, error: globalsError } = await supabase\r\n      .from(\"globals\")\r\n      .select(\"*\")\r\n      .eq(\"tenant_id\", tenantId)\r\n      .eq(\"status\", \"published\");\r\n\r\n    if (globalsError) {\r\n      return { error: globalsError.message };\r\n    }\r\n\r\n    return { data: globals || [] };\r\n  } catch (error) {\r\n    return { error: error instanceof Error ? error.message : \"Unknown error\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Get all globals (including drafts) for editing\r\n */\r\nexport async function getAllGlobals() {\r\n  try {\r\n    const tenantId = await getTenantIdForServerAction();\r\n    if (!tenantId) {\r\n      return { error: \"Tenant not found\" };\r\n    }\r\n\r\n    const supabase = supabaseServer();\r\n\r\n    // Get all globals for tenant\r\n    const { data: globals, error: globalsError } = await supabase\r\n      .from(\"globals\")\r\n      .select(\"*\")\r\n      .eq(\"tenant_id\", tenantId)\r\n      .order(\"key\");\r\n\r\n    if (globalsError) {\r\n      return { error: globalsError.message };\r\n    }\r\n\r\n    return { data: globals || [] };\r\n  } catch (error) {\r\n    return { error: error instanceof Error ? error.message : \"Unknown error\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Save globals\r\n */\r\nexport async function saveGlobals(globals: Array<{ key: string; value: any; status?: string }>) {\r\n  try {\r\n    const tenantId = await getTenantIdForServerAction();\r\n    if (!tenantId) {\r\n      return { error: \"Tenant not found\" };\r\n    }\r\n\r\n    const supabase = supabaseServer();\r\n\r\n    // Upsert each global\r\n    const results = [];\r\n    for (const globalItem of globals) {\r\n      const { data, error } = await supabase\r\n        .from(\"globals\")\r\n        .upsert(\r\n          {\r\n            tenant_id: tenantId,\r\n            key: globalItem.key,\r\n            value: globalItem.value,\r\n            status: globalItem.status || \"published\",\r\n          },\r\n          {\r\n            onConflict: \"tenant_id,key\",\r\n          }\r\n        )\r\n        .select()\r\n        .single();\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n      results.push(data);\r\n    }\r\n\r\n    revalidatePath(\"/api/public/globals\");\r\n    return { data: results };\r\n  } catch (error) {\r\n    return { error: error instanceof Error ? error.message : \"Unknown error\" };\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OASO,eAAe,IACpB,GAAI,CAEF,IAAM,EAAc,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,IAC3B,EAAO,EAAY,GAAG,CAAC,SAAW,EAAY,GAAG,CAAC,oBAExD,GAAI,EAAM,CAER,IAAM,EADW,AACH,EADQ,KAAK,CAAC,IAAI,CAAC,EAAE,CACZ,KAAK,CAAC,KAG7B,GAAI,EAAM,MAAM,CAAG,EAAG,CACpB,IAAM,EAAa,CAAK,CAAC,EAAE,CACrB,EAAW,CAAA,EAAA,EAAA,cAAA,AAAc,IACzB,CAAE,KAAM,CAAM,OAAE,CAAK,CAAE,CAAG,MAAM,EACnC,IAAI,CAAC,WACL,MAAM,CAAC,MACP,EAAE,CAAC,OAAQ,GACX,WAAW,GAEd,GAAI,GAAU,CAAC,EACb,KADoB,EACb,EAAO,EAAE,AAEpB,CACF,CAGA,IAAM,EAAc,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,IAC3B,EAAW,CAAA,EAAA,EAAA,kBAAA,AAAkB,EAAA,2CAAA,mNAGjC,CACE,QAAS,KACP,AAAI,GACK,CADO,CACK,GAAG,CAAC,IAAO,KAElC,CACF,GAGI,CAAE,KAAM,MAAE,CAAI,CAAE,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAEtD,GAAI,EAAM,CAER,GAAM,CAAE,KAAM,CAAU,CAAE,MAAO,CAAe,CAAE,CAAG,MAAM,EACxD,IAAI,CAAC,gBACL,MAAM,CAAC,aACP,EAAE,CAAC,UAAW,EAAK,EAAE,EACrB,KAAK,CAAC,GACN,WAAW,GAEd,GAAI,GAAY,WAAa,CAAC,EAC5B,OAAO,EAAW,MAD2B,GAClB,AAE/B,CAGA,IAAM,EAAgB,CAAA,EAAA,EAAA,cAAA,AAAc,IAC9B,CAAE,KAAM,CAAa,CAAE,MAAO,CAAkB,CAAE,CAAG,MAAM,EAC9D,IAAI,CAAC,WACL,MAAM,CAAC,MACP,EAAE,CAAC,OAAQ,eACX,WAAW,GAEd,GAAI,GAAiB,CAAC,EACpB,OAAO,EAAc,EAAE,CAGzB,MAJ0C,CAInC,IACT,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,2BAA4B,GACnC,IACT,CACF,mFCnFA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAKO,eAAe,IACpB,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,0BAAA,AAA0B,IACjD,GAAI,CAAC,EACH,MAAO,CAAE,CADI,KACG,kBAAmB,EAGrC,IAAM,EAAW,CAAA,EAAA,EAAA,cAAA,AAAc,IAGzB,CAAE,KAAM,CAAO,CAAE,MAAO,CAAY,CAAE,CAAG,MAAM,EAClD,IAAI,CAAC,WACL,MAAM,CAAC,KACP,EAAE,CAAC,YAAa,GAChB,EAAE,CAAC,SAAU,aAEhB,GAAI,EACF,MAAO,CAAE,KADO,CACA,EAAa,OAAO,AAAC,EAGvC,MAAO,CAAE,KAAM,GAAW,EAAG,AAAD,CAC9B,CAAE,MAAO,EAAO,CACd,MAAO,CAAE,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,eAAgB,CAC3E,CACF,CAKO,eAAe,IACpB,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,0BAAA,AAA0B,IACjD,GAAI,CAAC,EACH,MAAO,CAAE,CADI,KACG,kBAAmB,EAGrC,IAAM,EAAW,CAAA,EAAA,EAAA,cAAc,AAAd,IAGX,CAAE,KAAM,CAAO,CAAE,MAAO,CAAY,CAAE,CAAG,MAAM,EAClD,IAAI,CAAC,WACL,MAAM,CAAC,KACP,EAAE,CAAC,YAAa,GAChB,KAAK,CAAC,OAET,GAAI,EACF,MAAO,CAAE,KADO,CACA,EAAa,OAAO,AAAC,EAGvC,MAAO,CAAE,KAAM,GAAW,EAAE,AAAC,CAC/B,CAAE,MAAO,EAAO,CACd,MAAO,CAAE,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,eAAgB,CAC3E,CACF,CAKO,eAAe,EAAY,CAA4D,EAC5F,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,0BAA0B,AAA1B,IACvB,GAAI,CAAC,EACH,MAAO,CAAE,CADI,KACG,kBAAmB,EAGrC,IAAM,EAAW,CAAA,EAAA,EAAA,cAAA,AAAc,IAGzB,EAAU,EAAE,CAClB,IAAK,IAAM,KAAc,EAAS,CAChC,GAAM,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,WACL,MAAM,CACL,CACE,UAAW,EACX,IAAK,EAAW,GAAG,CACnB,MAAO,EAAW,KAAK,CACvB,OAAQ,EAAW,MAAM,EAAI,WAC/B,EACA,CACE,WAAY,eACd,GAED,MAAM,GACN,MAAM,GAET,GAAI,EACF,KADS,CACF,CAAE,MAAO,EAAM,OAAO,AAAC,EAEhC,EAAQ,IAAI,CAAC,EACf,CAGA,MADA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,uBACR,CAAE,KAAM,CAAQ,CACzB,CAAE,MAAO,EAAO,CACd,MAAO,CAAE,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,eAAgB,CAC3E,CACF,0CAjGsB,EA6BA,EA6BA,IA1DA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA6BA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA6BA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA"}