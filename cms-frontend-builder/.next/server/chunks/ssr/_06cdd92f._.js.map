{"version":3,"sources":["../../../../../src/lib/tenant-server.ts","../../../../../src/actions/posts.ts","../../../../../cms-frontend-builder/.next-internal/server/app/%28cms%29/posts/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["import { headers } from \"next/headers\";\r\nimport { cookies } from \"next/headers\";\r\nimport { createServerClient } from \"@supabase/ssr\";\r\nimport { supabaseServer } from \"./supabase\";\r\n\r\n/**\r\n * Gets the tenant ID for the current request.\r\n * Tries multiple strategies:\r\n * 1. From host subdomain (production)\r\n * 2. From user's session via tenant_users table (development/localhost)\r\n * 3. Default tenant \"kalitechnia\" as fallback\r\n */\r\nexport async function getTenantIdForServerAction(): Promise<string | null> {\r\n  try {\r\n    // Strategy 1: Try to get from host subdomain\r\n    const headersList = await headers();\r\n    const host = headersList.get(\"host\") || headersList.get(\"x-forwarded-host\");\r\n\r\n    if (host) {\r\n      const hostname = host.split(\":\")[0];\r\n      const parts = hostname.split(\".\");\r\n\r\n      // If we have a subdomain (more than 2 parts), use it\r\n      if (parts.length > 2) {\r\n        const tenantSlug = parts[0];\r\n        const supabase = supabaseServer();\r\n        const { data: tenant, error } = await supabase\r\n          .from(\"tenants\")\r\n          .select(\"id\")\r\n          .eq(\"slug\", tenantSlug)\r\n          .maybeSingle();\r\n\r\n        if (tenant && !error) {\r\n          return tenant.id;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Strategy 2: Get from user's session (for localhost/development)\r\n    const cookieStore = await cookies();\r\n    const supabase = createServerClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n      {\r\n        cookies: {\r\n          get(name: string) {\r\n            return cookieStore.get(name)?.value;\r\n          },\r\n        },\r\n      }\r\n    );\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (user) {\r\n      // Get user's first tenant from tenant_users\r\n      const { data: tenantUser, error: tenantUserError } = await supabase\r\n        .from(\"tenant_users\")\r\n        .select(\"tenant_id\")\r\n        .eq(\"user_id\", user.id)\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (tenantUser?.tenant_id && !tenantUserError) {\r\n        return tenantUser.tenant_id;\r\n      }\r\n    }\r\n\r\n    // Strategy 3: Fallback to default tenant \"kalitechnia\"\r\n    const supabaseAdmin = supabaseServer();\r\n    const { data: defaultTenant, error: defaultTenantError } = await supabaseAdmin\r\n      .from(\"tenants\")\r\n      .select(\"id\")\r\n      .eq(\"slug\", \"kalitechnia\")\r\n      .maybeSingle();\r\n\r\n    if (defaultTenant && !defaultTenantError) {\r\n      return defaultTenant.id;\r\n    }\r\n\r\n    return null;\r\n  } catch (error) {\r\n    console.error(\"Error getting tenant ID:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n","\"use server\";\r\n\r\nimport { supabaseServer } from \"@/lib/supabase\";\r\nimport { getTenantIdForServerAction } from \"@/lib/tenant-server\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\n/**\r\n * List all posts for the current tenant\r\n */\r\nexport async function listPosts() {\r\n  try {\r\n    const tenantId = await getTenantIdForServerAction();\r\n    if (!tenantId) {\r\n      return { error: \"Tenant not found\" };\r\n    }\r\n\r\n    const supabase = supabaseServer();\r\n\r\n    // Get all posts for tenant\r\n    const { data: posts, error: postsError } = await supabase\r\n      .from(\"posts\")\r\n      .select(\"*\")\r\n      .eq(\"tenant_id\", tenantId)\r\n      .order(\"updated_at\", { ascending: false });\r\n\r\n    if (postsError) {\r\n      return { error: postsError.message };\r\n    }\r\n\r\n    return { data: posts || [] };\r\n  } catch (error) {\r\n    return { error: error instanceof Error ? error.message : \"Unknown error\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Get a post by ID\r\n */\r\nexport async function getPostById(postId: string) {\r\n  try {\r\n    const tenantId = await getTenantIdForServerAction();\r\n    if (!tenantId) {\r\n      return { error: \"Tenant not found\" };\r\n    }\r\n\r\n    const supabase = supabaseServer();\r\n\r\n    // Get the post\r\n    const { data: post, error: postError } = await supabase\r\n      .from(\"posts\")\r\n      .select(\"*\")\r\n      .eq(\"id\", postId)\r\n      .eq(\"tenant_id\", tenantId)\r\n      .single();\r\n\r\n    if (postError) {\r\n      return { error: postError.message };\r\n    }\r\n\r\n    return { data: post };\r\n  } catch (error) {\r\n    return { error: error instanceof Error ? error.message : \"Unknown error\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Save or create a post\r\n */\r\nexport async function savePost(postId: string | null, data: {\r\n  title: string;\r\n  slug: string;\r\n  excerpt?: string;\r\n  content: any;\r\n  coverImage?: string | null;\r\n  status?: \"draft\" | \"published\" | \"archived\";\r\n}) {\r\n  try {\r\n    const tenantId = await getTenantIdForServerAction();\r\n    if (!tenantId) {\r\n      return { error: \"Tenant not found\" };\r\n    }\r\n\r\n    const supabase = supabaseServer();\r\n\r\n    if (postId) {\r\n      // Update existing post\r\n      const { data: post, error: updateError } = await supabase\r\n        .from(\"posts\")\r\n        .update({\r\n          title: data.title,\r\n          slug: data.slug,\r\n          excerpt: data.excerpt || null,\r\n          content: data.content,\r\n          status: data.status || \"draft\",\r\n          published_at: data.status === \"published\" ? new Date().toISOString() : null,\r\n        })\r\n        .eq(\"id\", postId)\r\n        .eq(\"tenant_id\", tenantId)\r\n        .select()\r\n        .single();\r\n\r\n      if (updateError) {\r\n        return { error: updateError.message };\r\n      }\r\n\r\n      revalidatePath(\"/\");\r\n      return { data: post };\r\n    } else {\r\n      // Create new post\r\n      const { data: post, error: createError } = await supabase\r\n        .from(\"posts\")\r\n        .insert({\r\n          tenant_id: tenantId,\r\n          title: data.title,\r\n          slug: data.slug,\r\n          excerpt: data.excerpt || null,\r\n          content: data.content,\r\n          status: data.status || \"draft\",\r\n          published_at: data.status === \"published\" ? new Date().toISOString() : null,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (createError) {\r\n        return { error: createError.message };\r\n      }\r\n\r\n      revalidatePath(\"/\");\r\n      return { data: post };\r\n    }\r\n  } catch (error) {\r\n    return { error: error instanceof Error ? error.message : \"Unknown error\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Publish a post\r\n */\r\nexport async function publishPost(postId: string) {\r\n  try {\r\n    const tenantId = await getTenantIdForServerAction();\r\n    if (!tenantId) {\r\n      return { error: \"Tenant not found\" };\r\n    }\r\n\r\n    const supabase = supabaseServer();\r\n\r\n    // Update post status\r\n    const { data: post, error: updateError } = await supabase\r\n      .from(\"posts\")\r\n      .update({\r\n        status: \"published\",\r\n        published_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", postId)\r\n      .eq(\"tenant_id\", tenantId)\r\n      .select()\r\n      .single();\r\n\r\n    if (updateError) {\r\n      return { error: updateError.message };\r\n    }\r\n\r\n    revalidatePath(\"/\");\r\n    return { data: post };\r\n  } catch (error) {\r\n    return { error: error instanceof Error ? error.message : \"Unknown error\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Delete a post\r\n */\r\nexport async function deletePost(postId: string) {\r\n  try {\r\n    const tenantId = await getTenantIdForServerAction();\r\n    if (!tenantId) {\r\n      return { error: \"Tenant not found\" };\r\n    }\r\n\r\n    const supabase = supabaseServer();\r\n\r\n    // Delete post\r\n    const { error: deleteError } = await supabase\r\n      .from(\"posts\")\r\n      .delete()\r\n      .eq(\"id\", postId)\r\n      .eq(\"tenant_id\", tenantId);\r\n\r\n    if (deleteError) {\r\n      return { error: deleteError.message };\r\n    }\r\n\r\n    revalidatePath(\"/\");\r\n    return { data: { success: true } };\r\n  } catch (error) {\r\n    return { error: error instanceof Error ? error.message : \"Unknown error\" };\r\n  }\r\n}\r\n\r\n","export {listPosts as '0009b2d854ecdafc67348394fb57003b51618a8d67'} from 'ACTIONS_MODULE0'\nexport {getPostById as '400156b8ce56fc4d15c8949f5298bb26e8bd76e735'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":"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"}